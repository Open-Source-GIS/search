<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title></title>
    <style type="text/css" media="all">
      /* <![CDATA[ */
      body {
	  border: 23px solid #898989;
	  font-family: sans-serif;
	  height: 100%;
	  margin: 0;
	  padding: 13px;
      }
      #search {
	  background: none repeat scroll 0 0 #404040;
	  color: #FFFFFF;
	  margin: 0;
	  padding: 21px;
      }
      input[type=text] {
	  padding: 5px;
      }
      #results div {
	  margin: 17px 0;
	  width: 47em;
      }
      em {
	  font-style: normal;
	  font-weight: bold;
      }
      span.thumb {
	  display: inline-block;
	  height: 66px;
	  vertical-align: middle;
	  width: 86px;
      }
      span.thumb img {
	  border: 1px solid #595960;
	  box-shadow: 3px 3px 6px #9898B5;
      }
      span.sourceName {
	  display: inline-block;
	  border: 1px outset gray;
	  border-radius: 6px;
	  padding: 7px;
	  color: gray;
	  background: #DEDEDE;
	  margin-right: 15px;
      }
      a {
	  text-decoration: none;
	  color: default;
      } 
      .total {
	  color: #ABABAB;
	  font-size: 60%;
	  padding: 0 5px 0 2px;
	  vertical-align: text-top;
	  display: inline-block;
	  width: 2em;
      }
      #report {
	  color: #828282;
	  font-size: 75%;
      }
      /* ]]> */
    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="jquery.ba-bbq.min.js"></script>
    <script type="text/javascript" src="underscore-min.js"></script>
    <script type="text/javascript">
      // <![CDATA[
$(function () {
    jQuery.ajaxSettings.traditional = true;

    var sources = ["photo", "sfd", "drewblog", "chat", "aribot"];
    var totalSpan = {}; // source : span
    var currentParams;

    function init() {
	$.each(sources, function (i, s) {
	    var inp = $("<input>").attr({type: "checkbox", name: "source", 
		value: s, id: "source-"+i, checked: true});

	    totalSpan[s] = $("<span>").addClass("total");
	    $("#sources").append(inp)
		.append($("<label>").attr("for", "source-"+i).text(s))
		.append(totalSpan[s]); 
	});
    }

    function writeUiToFragment() {
	var checkedSources = [];
	$("input[name=source]:checked").each(function (i, s) { 
	    checkedSources.push($(this).val());
	});
	checkedSources.sort();
	var params = {
	    source: checkedSources, 
	    q: $("input[name=q]").val(), 
	    from: 0}
	$.bbq.pushState(params);
	return params;
    }

    function writeFragmentToUi() {
	var params = $.bbq.getState();
	console.log("to ui", params);
	$("input[name=q]").val(params.q || "");

	if (!params['source']) {
	    $("input[name=source]").attr("checked", true);
	} else {
	    $("input[name=source]").attr("checked", false);
	    $.each(params['source'], function (i, s) {
		$("#sources input[value="+s+"]").attr("checked", true);
	    });
	}
	//offset
    }

    function onUiChange() {
	var params = writeUiToFragment();
	if (!_.isEqual(params, currentParams)) {
	    runSearch(params);
	}
	return false;
    }

    function onHashChange(ev) {
	var params = ev.getState();
	if (!_.isEqual(params, currentParams)) {
	    writeFragmentToUi();
	    runSearch(params);
	}
    }

    function runSearch(params) {
	if (_.isEqual(params, currentParams)) {
	    return;
	}
	currentParams = params;

	// debounce, here

	$("#results").empty();
	$("#sources .total").text("0");
	console.log("para", params)
	if (!params.q || !params.source) { 
	    $("#report").text("Nothing to search for.");
	    return;
	}
	$("#report").text("Searching...");

	$.getJSON("search", params, function (ret) { 
	    $("#results").empty();
	    $.each(ret.hits, function (i, row) {
		var div = $("<div>");
		div.html(row.text);
		if (row.source == "photo") {
		    div.prepend($("<span>").addClass("thumb").append(
			$("<img>").attr("src", row.uri + "?size=thumb")));
		} else {
		    div.prepend($("<span>").addClass("sourceName")
				.text(row.source));
		}
		div.wrapInner($("<a>").attr("href", row.view || row.uri));
		$("#results").append(div);
	    });
	    $.each(ret.sourceTotals, function (k, v) {
		totalSpan[k].text(v);
	    });
	    $("#report").text("Found "+ret.totalHits+" hits in "+
			      ret.took+" ms"); 
	});
	return false;
    }

    init();
    writeFragmentToUi();
    $("input[name=q]").change(onUiChange).keyup(onUiChange).focus();
    $("input[name=source]").change(onUiChange);
    //$(window).bind("hashchange", onHashChange);
    onHashChange($.bbq);
});
      // ]]>
    </script>
  </head>
  <body>
    <div id="search">
      <div>Search: <input type="text" name="q"/></div>
      <div id="sources">Sources: </div>
      <div id="report"></div>
    </div>
    <div id="pages"></div>
    <div id="results">
    </div>
  </body>
</html>